# Кэширующий веб-сервер

Это REST API для управления документами, пользователями и аутентификацией с поддержкой кэширования. Сервер интегрируется с PostgreSQL для хранения данных, Redis для кэширования и AWS S3 (или совместимым хранилищем, например, MinIO) для хранения файлов. Используется JSON Web Tokens (JWT) для аутентификации и поддерживаются pre-signed URL для безопасной загрузки и скачивания файлов.

## Предисловие

- Работа с файлами реализована через S3 с использованием **MINIO**. Когда вы создаете документ (файл), то происходит генерация pre-signed PUT URL для асинхронной загрузки в S3. Вам ничего дополнительно не требуется делать.
- Когда же вы обращаетесь к файлу, то генерируется pre-signed GET URL следующего вида:
    - `http://minio:9000/my-s3-bucket/users/5ed924a2-` — когда приложение развернуто в докере;
    - `http://localhost:9000/my-s3-bucket/users/5ed924a2-` — когда приложение развернуто локально.
- Когда приложение развернуто локально, то можно просто перейти по ссылке и вы получите файл, который хранился в S3.
- Но когда приложение развернуто в докере вы можете либо открыть UI версию MINIO, доступной по адресу `http://localhost:9001/` или `http://localhost:9001/browser/my-s3-bucket`, там уже вы сможете просматривать все файлы. Если же вы развернули приложение в докер контейнере, то можете проксировать MinIO через Nginx или Traefik или же использовать `docker exec`, если нужно просто скачать файл из интернета.
- Данные для входа в MINIO UI:
  - Логин: minioadmin
  - Пароль: minioadmin

# Версии компонентов системы

Ниже приведены версии компонентов, используемых в системе, согласно конфигурации Docker:

- **Golang**: 1.24.4 (на основе образа `golang:1.24.4-alpine`)
- **Alpine**: 3.18 (на основе образа `alpine:3.18`)
- **PostgreSQL**: 15 (на основе образа `postgres:15`)
- **Redis**: 7 (на основе образа `redis:7`)
- **MinIO**: Последняя версия (на основе образа `minio/minio:latest`)

## Возможности

- **Управление пользователями**: Регистрация, обновление, удаление и получение списка пользователей.
- **Аутентификация**: Вход, выход, обновление токена и получение информации о текущем пользователе.
- **Управление документами**: Создание, просмотр, совместное использование и удаление документов с поддержкой публичного и приватного доступа.
- **Интеграция с S3**: Асинхронная загрузка и скачивание файлов с использованием pre-signed URL.
- **Кэширование**: Кэширование метаданных документов в Redis с настраиваемым TTL.
- **Swagger-документация**: Документация API доступна по адресу `/swagger/*`.

## Технологический стек

- **Язык**: Go
- **Фреймворк**: Chi (HTTP-роутер)
- **База данных**: PostgreSQL
- **Кэш**: Redis
- **Хранилище**: AWS S3 или совместимое (например, MinIO)
- **Аутентификация**: JWT
- **Конфигурация**: YAML
- **Документация API**: Swagger

## Требования

- Go 1.18 или выше
- PostgreSQL
- Redis
- AWS S3 или MinIO
- Docker (опционально, для запуска зависимостей)

## Установка

1. **Клонирование репозитория**:
   ```bash
   git clone <repository-url>
   cd caching-web-server
   ```

2. **Установка зависимостей**:
   ```bash
   go mod download
   ```

3. **Настройка конфигурации**:
   Настраивайте `config.yaml`. Пример файла из проекта:
   ```yaml
   databaseConfig:
     dsn: "postgresql://user:password@postgres:5432/appdb?sslmode=disable"
   TTL:
     s3_and_redis: 900
   redisConfig:
     address: "redis:6379"
     password: ""
     database: 0
   s3Config:
     bucket: "my-s3-bucket"
     region: "us-east-1"
     endpoint: "http://minio:9000"
     local: true
   serverAddr: ":8080"
   jwt:
     secret_key: "8fb90cf688f1f46a5a59711b9a8804c441e86513b7909fefb1b8abfc78aa500c"
     access_token_ttl: "90m"
     refresh_token_ttl: "10h"
   webhook:
     url: "https://webhook.site/673e03a4-b1bb-4546-88fa-9a521c61a1d0"
   admin:
     admin_token: "super-secret-admin-token"
   ```

4. **Настройка базы данных**: 
   Со стартом проекта выполняется `init/db_init.sql`, который создает таблицы для PostgreSQL.
   Убедитесь, что PostgreSQL запущен, и, если нужно, создайте необходимую базу данных самостоятельно. Смотрите содержимое `init/db_init.sql`:
   ```bash
   psql -U user -c "CREATE DATABASE appdb;"
   ```

5. **Запуск зависимостей (опционально с Docker)**:
   Запустите PostgreSQL, Redis и MinIO с помощью Docker:
   ```bash
   docker-compose up -d
   ```

6. **Сборка и запуск проекта в Docker**:
   ```bash
   docker-compose build --no-cache
   docker-compose up -d
   ```

Сервер будет доступен по адресу `http://localhost:8080`.

## Эндпоинты API

### Аутентификация
- **POST /api/auth/**: Вход в систему с использованием учетных данных.
- **DELETE /api/auth/{token}**: Выход из системы с аннулированием токена.
- **GET /api/auth/me**: Получение UUID текущего пользователя (требуется JWT).
- **HEAD /api/auth/me**: Проверка доступности UUID текущего пользователя (требуется JWT).
- **POST /api/auth/refresh**: Обновление JWT-токена доступа.

### Управление пользователями
- **POST /api/register**: Регистрация нового пользователя.
- **GET /api/users**: Получение списка всех пользователей.
- **HEAD /api/users**: Проверка доступности списка пользователей.
- **GET /api/users/{uuid}**: Получение данных пользователя (требуется JWT).
- **HEAD /api/users/{uuid}**: Проверка доступности данных пользователя (требуется JWT).
- **PUT /api/users/{uuid}**: Обновление данных пользователя (требуется JWT).
- **PUT /api/users/{uuid}/password**: Обновление пароля пользователя (требуется JWT).
- **DELETE /api/users/delete**: Удаление пользователя (требуется JWT).

### Управление документами
- **POST /api/docs/**: Создание нового документа с загрузкой файла (требуется JWT).
    - Генерирует pre-signed PUT URL для асинхронной загрузки в S3.
    - Поддерживает параметр `public` (true/false) для установки видимости документа.
- **GET /api/docs/**: Получение списка документов авторизованного пользователя (требуется JWT).
- **HEAD /api/docs/**: Проверка доступности списка документов (требуется JWT).
- **GET /api/docs/{doc_id}**: Получение данных документа (требуется JWT).
    - Генерирует pre-signed GET URL для скачивания документа из S3.
- **HEAD /api/docs/{doc_id}**: Проверка доступности документа (требуется JWT).
- **POST /api/docs/{doc_id}/share**: Предоставление доступа к документу другому пользователю (требуется JWT).
- **POST /api/docs/{doc_id}/remove**: Удаление прав доступа к документу (требуется JWT).
- **DELETE /api/docs/{doc_id}**: Удаление документа (требуется JWT).
- **GET /public/docs/{doc_id}**: Получение публичного документа по UUID.
- **GET /public/docs/token/{token}**: Получение публичного документа по токену.
- **HEAD /public/docs/token/{token}**: Проверка доступности публичного документа по токену.
- **GET /api/docs/public/{token}**: Получение документа по токену.